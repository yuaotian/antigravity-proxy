name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "å‘å¸ƒç‰ˆæœ¬å·ï¼ˆç¤ºä¾‹ï¼š1.2 æˆ– 1.2.3ï¼‰"
        required: true
        default: "1.1"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [x64, x86]

    outputs:
      release_tag: ${{ steps.prepare_version.outputs.release_tag }}
      release_version: ${{ steps.prepare_version.outputs.release_version }}

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    # ç»Ÿä¸€ç‰ˆæœ¬å·ä¸ tagï¼Œå…¼å®¹ tag è§¦å‘ä¸æ‰‹åŠ¨è§¦å‘
    - name: å‡†å¤‡ç‰ˆæœ¬å·
      id: prepare_version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $rawVersion = "${{ inputs.version }}"
          $normalized = $rawVersion.Trim()
          if ($normalized.StartsWith("v")) { $normalized = $normalized.Substring(1) }
          $tag = "v$normalized"
        } else {
          $tag = "${{ github.ref_name }}"
          $normalized = $tag
          if ($normalized.StartsWith("v")) { $normalized = $normalized.Substring(1) }
        }
        "release_tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        "release_version=$normalized" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    # å°†æœ¬æ¬¡å‘å¸ƒç‰ˆæœ¬å·åŒæ­¥åˆ° build.ps1ï¼Œç¡®ä¿äº§ç‰©å†…ç‰ˆæœ¬å·ä¸ tag ä¸€è‡´
    - name: åŒæ­¥ç‰ˆæœ¬å·åˆ° build.ps1
      shell: pwsh
      run: |
        $ver = "${{ steps.prepare_version.outputs.release_version }}"
        if ([string]::IsNullOrWhiteSpace($ver)) {
          Write-Error "å‘å¸ƒç‰ˆæœ¬å·ä¸ºç©ºï¼Œæ— æ³•åŒæ­¥åˆ° build.ps1"
          exit 1
        }

        $path = Join-Path $env:GITHUB_WORKSPACE "build.ps1"
        if (-not (Test-Path $path)) {
          Write-Error "æœªæ‰¾åˆ° build.ps1ï¼š$path"
          exit 1
        }

        $content = Get-Content -Path $path -Raw -Encoding UTF8
        $pattern = '(?m)^\s*\$Version\s*=\s*".*?"\s*$'
        if (-not [regex]::IsMatch($content, $pattern)) {
          Write-Error "æœªåœ¨ build.ps1 ä¸­æ‰¾åˆ° `$Version = \"...\"` ç‰ˆæœ¬å·è¡Œï¼Œæ— æ³•è‡ªåŠ¨æ›´æ–°ã€‚"
          exit 1
        }

        $replacement = ('$Version = "{0}"' -f $ver)
        $newContent = [regex]::Replace($content, $pattern, $replacement, 1)
        Set-Content -Path $path -Value $newContent -Encoding UTF8
        Write-Host "å·²åŒæ­¥ build.ps1 ç‰ˆæœ¬å·ä¸ºï¼š$ver"

    # ä½¿ç”¨ build.ps1 ç»Ÿä¸€ç¼–è¯‘é€»è¾‘ï¼Œé¿å…ä¸æœ¬åœ°æµç¨‹åå·®
    - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼ˆReleaseï¼Œå…ˆæ¸…ç†ï¼‰
      shell: pwsh
      run: .\build.ps1 -Clean -Config Release -Arch ${{ matrix.arch }}

    # æ‰“åŒ… output ç›®å½•ä¸º Release èµ„äº§
    - name: æ‰“åŒ…äº§ç‰©
      id: package
      shell: pwsh
      run: |
        $zipName = "antigravity-proxy-${{ steps.prepare_version.outputs.release_tag }}-win-${{ matrix.arch }}.zip"
        $zipPath = Join-Path $env:RUNNER_TEMP $zipName
        if (Test-Path $zipPath) { Remove-Item -Force $zipPath }
        Compress-Archive -Path "output/*" -DestinationPath $zipPath -Force
        "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    # ä¸Šä¼  zipï¼Œä¾›å‘å¸ƒä½œä¸šç»Ÿä¸€ä¸Šä¼ åˆ° Release
    - name: ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: release-asset-${{ matrix.arch }}
        path: ${{ steps.package.outputs.zip_path }}
        if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
    # æ£€å‡ºä»“åº“ä»¥è·å– git å†å²è®°å½•ï¼ˆç”Ÿæˆå‘å¸ƒè¯´æ˜éœ€è¦ï¼‰
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # åŸºäº git æäº¤å†å²ç”Ÿæˆç»“æ„åŒ–å‘å¸ƒè¯´æ˜
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: changelog
      shell: bash
      run: |
        set -e
        CURRENT_TAG="${{ needs.build.outputs.release_tag }}"
        
        # è·å–ä¸Šä¸€ä¸ª tagï¼ˆæ’é™¤å½“å‰ tagï¼‰
        PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]' | grep -v "^${CURRENT_TAG}$" | head -n 1 || true)
        
        if [ -z "$PREV_TAG" ]; then
          echo "é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤è®°å½•"
          COMMIT_RANGE="HEAD"
        else
          echo "ä» $PREV_TAG åˆ° $CURRENT_TAG çš„æäº¤"
          COMMIT_RANGE="${PREV_TAG}..HEAD"
        fi
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨å„ç±»å‹æäº¤
        TMPDIR=$(mktemp -d)
        for type in feat fix perf refactor docs chore style test build ci other; do
          touch "$TMPDIR/$type.txt"
        done
        
        # è·å–æäº¤åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªæäº¤
        git log $COMMIT_RANGE --pretty=format:'%h|%s' --no-merges 2>/dev/null | while IFS='|' read -r sha subject; do
          [ -z "$sha" ] && continue
          
          # è·å–è¯¥æäº¤çš„ body
          body=$(git log -1 --pretty=format:'%b' "$sha" 2>/dev/null | sed '/^$/d' || true)
          
          # æå–ç±»å‹å’ŒèŒƒå›´ï¼Œä½¿ç”¨ grep + sed
          if echo "$subject" | grep -qE '^[a-z]+(\([^)]+\))?:'; then
            TYPE=$(echo "$subject" | sed -E 's/^([a-z]+)(\([^)]+\))?:.*/\1/')
            SCOPE=$(echo "$subject" | sed -E 's/^[a-z]+(\([^)]+\))?:.*/\1/' | tr -d '()')
            DESC=$(echo "$subject" | sed -E 's/^[a-z]+(\([^)]+\))?:[[:space:]]*//')
            
            # æ ¼å¼åŒ–æ¡ç›®
            if [ -n "$SCOPE" ] && [ "$SCOPE" != "$TYPE" ]; then
              ENTRY="- **${SCOPE}**: ${DESC} (\`${sha}\`)"
            else
              ENTRY="- ${DESC} (\`${sha}\`)"
            fi
            
            # æ·»åŠ  bodyï¼ˆå¦‚æœæœ‰ï¼‰
            if [ -n "$body" ]; then
              BODY_FORMATTED=$(echo "$body" | sed 's/^/  /')
              ENTRY="${ENTRY}"$'\n'"${BODY_FORMATTED}"
            fi
            
            # å†™å…¥å¯¹åº”ç±»å‹æ–‡ä»¶
            case "$TYPE" in
              feat)     echo "$ENTRY" >> "$TMPDIR/feat.txt" ;;
              fix)      echo "$ENTRY" >> "$TMPDIR/fix.txt" ;;
              perf)     echo "$ENTRY" >> "$TMPDIR/perf.txt" ;;
              refactor) echo "$ENTRY" >> "$TMPDIR/refactor.txt" ;;
              docs)     echo "$ENTRY" >> "$TMPDIR/docs.txt" ;;
              chore)    echo "$ENTRY" >> "$TMPDIR/chore.txt" ;;
              style)    echo "$ENTRY" >> "$TMPDIR/style.txt" ;;
              test)     echo "$ENTRY" >> "$TMPDIR/test.txt" ;;
              build)    echo "$ENTRY" >> "$TMPDIR/build.txt" ;;
              ci)       echo "$ENTRY" >> "$TMPDIR/ci.txt" ;;
              *)        echo "$ENTRY" >> "$TMPDIR/other.txt" ;;
            esac
          else
            # éæ ‡å‡†æ ¼å¼æäº¤
            echo "- ${subject} (\`${sha}\`)" >> "$TMPDIR/other.txt"
          fi
        done
        
        # æ„å»ºæœ€ç»ˆçš„å‘å¸ƒè¯´æ˜
        CHANGELOG=""
        
        add_section() {
          local file="$1"
          local title="$2"
          if [ -s "$file" ]; then
            CHANGELOG="${CHANGELOG}${title}"$'\n\n'
            CHANGELOG="${CHANGELOG}$(cat "$file")"$'\n\n'
          fi
        }
        
        add_section "$TMPDIR/feat.txt"     "## âœ¨ æ–°åŠŸèƒ½ (Features)"
        add_section "$TMPDIR/fix.txt"      "## ğŸ› Bug ä¿®å¤ (Bug Fixes)"
        add_section "$TMPDIR/perf.txt"     "## âš¡ æ€§èƒ½ä¼˜åŒ– (Performance)"
        add_section "$TMPDIR/refactor.txt" "## â™»ï¸ ä»£ç é‡æ„ (Refactoring)"
        add_section "$TMPDIR/docs.txt"     "## ğŸ“ æ–‡æ¡£æ›´æ–° (Documentation)"
        add_section "$TMPDIR/build.txt"    "## ğŸ“¦ æ„å»ºç›¸å…³ (Build)"
        add_section "$TMPDIR/ci.txt"       "## ğŸ‘· CI é…ç½® (CI)"
        add_section "$TMPDIR/chore.txt"    "## ğŸ”§ æ‚é¡¹ (Chores)"
        add_section "$TMPDIR/style.txt"    "## ğŸ’„ ä»£ç é£æ ¼ (Style)"
        add_section "$TMPDIR/test.txt"     "## âœ… æµ‹è¯• (Tests)"
        add_section "$TMPDIR/other.txt"    "## ğŸ“‹ å…¶ä»–æ›´æ–° (Other)"
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf "$TMPDIR"
        
        # å¦‚æœæ²¡æœ‰ä»»ä½•æäº¤è®°å½•
        [ -z "$CHANGELOG" ] && CHANGELOG="æš‚æ— æ›´æ–°è®°å½•"
        
        # ä½¿ç”¨ heredoc å†™å…¥å¤šè¡Œè¾“å‡ºï¼ˆGitHub Actions æ¨èæ–¹å¼ï¼‰
        {
          echo "body<<EOF"
          echo "$CHANGELOG"
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: ä¸‹è½½æ‰“åŒ…æ–‡ä»¶
      uses: actions/download-artifact@v4
      with:
        path: release-assets

    # åˆ›å»º/æ›´æ–° Releaseï¼Œä¸Šä¼ æ‰“åŒ…äº§ç‰©å¹¶ä½¿ç”¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜
    - name: å‘å¸ƒ GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.build.outputs.release_tag }}
        name: ${{ needs.build.outputs.release_tag }}
        target_commitish: ${{ github.sha }}
        files: release-assets/**/*.zip
        body: ${{ steps.changelog.outputs.body }}
